window.VideoPlayerState={UNSTARTED:-1,ENDED:0,PLAYING:1,PAUSED:2,BUFFERING:3,VIDEO_CUED:5};window.VideoPlayerModel=Backbone.Model.extend({REQUIRED_PERCENT_FOR_FULL_POINTS:.95,defaults:{percent_last_saved:0,seconds_watched_since_save:0,points:0,possible_points:750,youtube_id:"",player_state:VideoPlayerState.UNSTARTED,seconds_between_saves:30,percent_between_saves:.1},initialize:function(){_.bindAll(this);this.pointsSaved=0;this.set({wall_time_last_saved:new Date});this.fetch()},fetch:function(){var e=this;doRequest("/api/get_video_logs",[this.get("youtube_id")]).success(function(t){if(t.length===0)return;e.set({total_seconds_watched:t[0].total_seconds_watched,points:t[0].points,complete:t[0].complete});e.pointsSaved=t[0].points})},save:function(){var e=this;if(this.saving)return;this.saving=!0;this._updateSecondsWatchedSinceSave();var t=this.get("wall_time_last_saved");data={youtube_id:this.get("youtube_id"),total_seconds_watched:Math.floor(this.get("total_seconds_watched")),seconds_watched:this.get("seconds_watched_since_save"),points:this.get("points")};var n=doRequest("/api/save_video_log",data).success(function(t){e.pointsSaved=t.points;e.saving=!1}).error(function(){e.set({wall_time_last_saved:t});e.saving=!1});this.set({wall_time_last_saved:new Date,percent_last_saved:this.getPercentWatched(),seconds_watched_since_save:0});return n},getVideoPosition:function(){return!this.player||!this.player.currentTime?0:this.player.currentTime()||0},_updateSecondsWatchedSinceSave:function(){var e=new Date,t=(e-this.get("wallTimeLastPoll"))/1e3;this.set("wallTimeLastPoll",e);var n=this.getVideoPosition(),r=n-this.get("videoPositionLastPoll");this.set("videoPositionLastPoll",n);var i=Math.max(0,Math.min(2,r/t)),s=t*i,o=this.get("seconds_watched_since_save");if(s>0){o+=s;this.set("seconds_watched_since_save",o)}return o},_updatePointsEstimate:function(){var e=this.getDuration();if(e===0)return;var t=this.get("seconds_watched_since_save"),n=Math.min(1,t/e),r=n+this.pointsSaved/this.get("possible_points");r>this.REQUIRED_PERCENT_FOR_FULL_POINTS&&(r=1);var i=Math.floor(this.get("possible_points")*r);this.set({points:i})},_isAutoSaveIntervalExceeded:function(){var e=this.getDuration()*this.get("percent_between_saves"),t=Math.max(e,this.get("seconds_between_saves"));return this.get("seconds_watched_since_save")>t},updateAndSaveIfNeeded:function(){this._updateSecondsWatchedSinceSave();if(this._isAutoSaveIntervalExceeded())this.save();else{var e=this.getPercentWatched(),t=this.get("percent_last_saved"),n=this.REQUIRED_PERCENT_FOR_FULL_POINTS;t<n&&e>=n?this.save():this._updatePointsEstimate()}},getPercentWatched:function(){var e=this.getDuration();return e===0?0:Math.min(1,this.getVideoPosition()/e)},getDuration:function(){if(!this.player||!this.player.duration)return 0;var e=this.player.duration()||this.get("duration")||0;return Math.max(0,e)},setPlayerState:function(e){this._updateSecondsWatchedSinceSave();this._updatePointsEstimate();var t=this.get("player_state");this.set({player_state:e});e===VideoPlayerState.ENDED?this.save():e===VideoPlayerState.PAUSED&&this.get("seconds_watched_since_save")>1&&this.save()},whenPointsIncrease:function(e){e=_.debounce(e,500);this.bind("change:points",function(){var t=this.previous("points"),n=this.get("points");n>t&&e(n)})}});window.VideoView=Backbone.View.extend({_readyDeferred:null,initialize:function(){_.bindAll(this);this._readyDeferred=new $.Deferred;this.model=new VideoPlayerModel(this.options);this.player=this.model.player=_V_(this.$("video").attr("id"));this._beginIntervalUpdate();this._initializeEventListeners()},_initializeEventListeners:function(){var e=this;this.model.whenPointsIncrease(this._update_points);this.player.addEvent("loadstart",function(){}).addEvent("loadedmetadata",function(){}).addEvent("loadeddata",function(){}).addEvent("loadedalldata",function(){}).addEvent("play",function(){e.model.setPlayerState(VideoPlayerState.PLAYING)}).addEvent("pause",function(){e.model.setPlayerState(VideoPlayerState.PAUSED)}).addEvent("ended",function(){e.model.setPlayerState(VideoPlayerState.ENDED)}).addEvent("durationchange",function(){e.model.set("duration",e.player.duration())}).addEvent("progress",function(){}).addEvent("resize",function(){}).addEvent("volumechange",function(){}).addEvent("error",function(){}).addEvent("fullscreenchange",function(){})},_update_points:function(e){$(".points").text(e);$(".points-container").toggle(e>0)},setContainerSize:function(e,t){var n=e/t,r=e,i=t,s=this.model.get("width")/this.model.get("height");n>s?r=t*s:i=e/s;this.player.width(r).height(i)},_beginIntervalUpdate:function(){this.intervalId&&clearInterval(this.intervalId);this.intervalId=setInterval(this.model.updateAndSaveIfNeeded,1e4)},whenReady:function(e){this._readyDeferred.then(e)},playerReady:function(){this._readyDeferred.resolve()},play:function(){this.model.player&&this.model.player.playVideo&&this.model.player.playVideo()},pause:function(){this.model.player&&this.model.player.pauseVideo&&this.model.player.pauseVideo()},seekTo:function(e){this.model.player.seekTo(e)},close:function(){this.intervalId&&clearInterval(this.intervalId);this.remove()}});